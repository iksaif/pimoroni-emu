"""Pixel font data extracted from Pimoroni firmware.

This module contains bitmap font data for the 'winds' font used on Blinky.
Font format: Pimoroni Pixel Font (PPF)
- Each glyph has variable width but fixed height
- Bitmap data is 1 bit per pixel, packed into bytes (MSB first)
- Rows are packed with (width + 7) >> 3 bytes per row
"""

# Winds font - small, suitable for Blinky's 39x26 display
# Extracted from vendor/blinky2350/modules/c/picovector/micropython/assets.cpp

WINDS_FONT = {
    'name': 'Winds 7',
    'height': 7,  # Actual visible height (not the 12-row storage)
    'max_width': 10,
    # Each entry: (width, bitmap_rows) where bitmap_rows is a list of integers
    # representing packed pixel data for each row (MSB = leftmost pixel)
    'glyphs': {
        # Space
        ' ': (3, [0, 0, 0, 0, 0, 0, 0]),
        # Basic punctuation
        '!': (2, [0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x80]),
        '.': (2, [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80]),
        ',': (2, [0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80]),
        ':': (2, [0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00]),
        '?': (5, [0x70, 0x88, 0x08, 0x10, 0x20, 0x00, 0x20]),
        '-': (3, [0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x00]),
        "'": (2, [0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00]),
        # Numbers
        '0': (4, [0x60, 0x90, 0x90, 0x90, 0x90, 0x90, 0x60]),
        '1': (3, [0x40, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xe0]),
        '2': (4, [0x60, 0x90, 0x10, 0x20, 0x40, 0x80, 0xf0]),
        '3': (4, [0x60, 0x90, 0x10, 0x60, 0x10, 0x90, 0x60]),
        '4': (4, [0x20, 0x60, 0xa0, 0xa0, 0xf0, 0x20, 0x20]),
        '5': (4, [0xf0, 0x80, 0xe0, 0x90, 0x10, 0x90, 0x60]),
        '6': (4, [0x60, 0x90, 0x80, 0xe0, 0x90, 0x90, 0x60]),
        '7': (4, [0xf0, 0x10, 0x10, 0x20, 0x20, 0x40, 0x40]),
        '8': (4, [0x60, 0x90, 0x90, 0x60, 0x90, 0x90, 0x60]),
        '9': (4, [0x60, 0x90, 0x90, 0x70, 0x10, 0x10, 0x60]),
        # Uppercase letters
        'A': (5, [0x70, 0x88, 0x88, 0xf8, 0x88, 0x88, 0x88]),
        'B': (5, [0xf0, 0x88, 0x88, 0xf0, 0x88, 0x88, 0xf0]),
        'C': (5, [0x70, 0x88, 0x80, 0x80, 0x80, 0x88, 0x70]),
        'D': (5, [0xf0, 0x88, 0x88, 0x88, 0x88, 0x88, 0xf0]),
        'E': (5, [0xf8, 0x80, 0x80, 0xf0, 0x80, 0x80, 0xf8]),
        'F': (5, [0xf8, 0x80, 0x80, 0xf0, 0x80, 0x80, 0x80]),
        'G': (5, [0x70, 0x88, 0x80, 0x98, 0x88, 0x88, 0x70]),
        'H': (5, [0x88, 0x88, 0x88, 0xf8, 0x88, 0x88, 0x88]),
        'I': (5, [0xf8, 0x20, 0x20, 0x20, 0x20, 0x20, 0xf8]),
        'J': (5, [0x38, 0x08, 0x08, 0x08, 0x08, 0x88, 0x70]),
        'K': (5, [0x88, 0x90, 0xa0, 0xc0, 0xa0, 0x90, 0x88]),
        'L': (5, [0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xf8]),
        'M': (5, [0x88, 0xd8, 0xa8, 0x88, 0x88, 0x88, 0x88]),
        'N': (5, [0x88, 0xc8, 0xa8, 0x98, 0x88, 0x88, 0x88]),
        'O': (5, [0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70]),
        'P': (5, [0xf0, 0x88, 0x88, 0xf0, 0x80, 0x80, 0x80]),
        'Q': (5, [0x70, 0x88, 0x88, 0x88, 0xa8, 0x90, 0x68]),
        'R': (5, [0xf0, 0x88, 0x88, 0xf0, 0xa0, 0x90, 0x88]),
        'S': (5, [0x70, 0x88, 0x80, 0x70, 0x08, 0x88, 0x70]),
        'T': (5, [0xf8, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20]),
        'U': (5, [0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70]),
        'V': (5, [0x88, 0x88, 0x88, 0x88, 0x50, 0x50, 0x20]),
        'W': (5, [0x88, 0x88, 0x88, 0xa8, 0xa8, 0xa8, 0x50]),
        'X': (5, [0x88, 0x88, 0x50, 0x20, 0x50, 0x88, 0x88]),
        'Y': (5, [0x88, 0x88, 0x50, 0x20, 0x20, 0x20, 0x20]),
        'Z': (5, [0xf8, 0x08, 0x10, 0x20, 0x40, 0x80, 0xf8]),
        # Lowercase letters
        'a': (4, [0x00, 0x00, 0x60, 0x90, 0x70, 0x90, 0xf0]),
        'b': (4, [0x80, 0x80, 0xe0, 0x90, 0x90, 0x90, 0xe0]),
        'c': (4, [0x00, 0x00, 0x60, 0x90, 0x80, 0x90, 0x60]),
        'd': (4, [0x10, 0x10, 0x70, 0x90, 0x90, 0x90, 0x70]),
        'e': (4, [0x00, 0x00, 0x60, 0x90, 0xf0, 0x80, 0x60]),
        'f': (3, [0x20, 0x40, 0xe0, 0x40, 0x40, 0x40, 0x40]),
        'g': (4, [0x00, 0x10, 0x60, 0x90, 0x60, 0x80, 0x70]),
        'h': (4, [0x80, 0x80, 0xe0, 0x90, 0x90, 0x90, 0x90]),
        'i': (1, [0x80, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80]),
        'j': (3, [0x20, 0x00, 0x60, 0x20, 0x20, 0x20, 0xc0]),
        'k': (4, [0x80, 0x80, 0x90, 0xa0, 0xc0, 0xa0, 0x90]),
        'l': (2, [0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xc0]),
        'm': (5, [0x00, 0x00, 0xf0, 0xa8, 0xa8, 0xa8, 0xa8]),
        'n': (4, [0x00, 0x00, 0xe0, 0x90, 0x90, 0x90, 0x90]),
        'o': (4, [0x00, 0x00, 0x60, 0x90, 0x90, 0x90, 0x60]),
        'p': (4, [0x00, 0x00, 0xe0, 0x90, 0xe0, 0x80, 0x80]),
        'q': (4, [0x00, 0x00, 0x70, 0x90, 0x70, 0x10, 0x10]),
        'r': (3, [0x00, 0x00, 0x60, 0x80, 0x80, 0x80, 0x80]),
        's': (4, [0x00, 0x00, 0x60, 0x80, 0x60, 0x10, 0xe0]),
        't': (4, [0x00, 0x40, 0xf0, 0x40, 0x40, 0x40, 0x30]),
        'u': (4, [0x00, 0x00, 0x90, 0x90, 0x90, 0x90, 0x60]),
        'v': (4, [0x00, 0x00, 0x90, 0x90, 0x90, 0xa0, 0x40]),
        'w': (5, [0x00, 0x00, 0x88, 0xa8, 0xa8, 0xa8, 0x50]),
        'x': (4, [0x00, 0x00, 0x90, 0x90, 0x60, 0x90, 0x90]),
        'y': (4, [0x00, 0x00, 0x90, 0x90, 0x70, 0x10, 0x60]),
        'z': (3, [0x00, 0x00, 0xe0, 0x20, 0x40, 0x80, 0xe0]),
    }
}


class PixelFont:
    """Pixel font class that renders text using bitmap data."""

    def __init__(self, font_data=None):
        if font_data is None:
            font_data = WINDS_FONT
        self.name = font_data.get('name', 'Unknown')
        self.height = font_data.get('height', 7)
        self.max_width = font_data.get('max_width', 10)
        self.glyphs = font_data.get('glyphs', {})

    def get_glyph(self, char):
        """Get glyph data for a character.

        Returns: (width, bitmap_rows) or None if not found.
        """
        return self.glyphs.get(char)

    def measure_text(self, text):
        """Measure the width of text in pixels."""
        width = 0
        for char in str(text):
            glyph = self.get_glyph(char)
            if glyph:
                width += glyph[0] + 1  # glyph width + 1 pixel spacing
            else:
                width += 3  # Default width for unknown chars
        # Remove trailing space
        if width > 0:
            width -= 1
        return width, self.height

    def render_text(self, buffer, buf_width, buf_height, text, x, y, gray_value=255):
        """Render text to a buffer.

        Args:
            buffer: bytearray of size buf_width * buf_height
            buf_width: width of the buffer
            buf_height: height of the buffer
            text: string to render
            x: x position (left edge)
            y: y position (top edge)
            gray_value: grayscale value for pixels (0-255)
        """
        cursor_x = x

        for char in str(text):
            glyph = self.get_glyph(char)
            if glyph is None:
                # Unknown character - skip with default spacing
                cursor_x += 4
                continue

            glyph_width, bitmap_rows = glyph

            # Render each row of the glyph
            for row_idx, row_data in enumerate(bitmap_rows):
                py = y + row_idx
                if py < 0 or py >= buf_height:
                    continue

                # Check each pixel in the row
                for bit in range(glyph_width):
                    px = cursor_x + bit
                    if px < 0 or px >= buf_width:
                        continue

                    # Check if this bit is set (MSB first)
                    # The bit position from left is: 7 - bit (for first 8 bits)
                    bit_pos = 7 - bit
                    if row_data & (1 << bit_pos):
                        buffer[py * buf_width + px] = gray_value

            cursor_x += glyph_width + 1  # Move to next character position


# Default font instance
winds = PixelFont(WINDS_FONT)
