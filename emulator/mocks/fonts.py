"""Bitmap font support for PicoGraphics emulator.

Provides Pimoroni-compatible bitmap fonts. Downloads from GitHub on first use
and caches locally for subsequent runs.
"""

import os
import re
from pathlib import Path
from typing import Dict, List, Optional, Tuple

# Cache directory for downloaded fonts
CACHE_DIR = Path.home() / ".cache" / "pimoroni-emulator" / "fonts"


# Built-in bitmap8 font data (extracted from Pimoroni's open-source repo)
# Each character is up to 5 bytes wide, each byte is a vertical column (LSB at top)
# Heights: bitmap8 = 8 pixels, bitmap6 = 6 pixels
BITMAP8_WIDTHS = [
    3, 1, 3, 5, 4, 4, 4, 1, 3, 3, 3, 3, 2, 3, 2, 4,
    4, 3, 4, 4, 4, 4, 4, 4, 4, 4, 1, 2, 3, 3, 3, 4,
    4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 4, 4, 4, 5, 4, 4,
    4, 4, 4, 4, 5, 4, 4, 5, 4, 4, 4, 2, 4, 2, 3, 3,
    4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 4, 4, 3, 5, 4, 4,
    4, 4, 4, 4, 4, 4, 4, 5, 4, 4, 4, 3, 1, 3, 4, 1,
]

BITMAP8_DATA = [
    # Space through / (ASCII 32-47)
    0x00,0x00,0x00,0x00,0x00, 0x5f,0x00,0x00,0x00,0x00, 0x03,0x00,0x03,0x00,0x00,
    0x28,0x7c,0x28,0x7c,0x28, 0x24,0x7a,0x2f,0x12,0x00, 0x66,0x10,0x08,0x66,0x00,
    0x36,0x49,0x49,0x7c,0x00, 0x03,0x00,0x00,0x00,0x00, 0x1c,0x22,0x41,0x00,0x00,
    0x41,0x22,0x1c,0x00,0x00, 0x54,0x38,0x54,0x00,0x00, 0x10,0x38,0x10,0x00,0x00,
    0x80,0x60,0x00,0x00,0x00, 0x10,0x10,0x10,0x00,0x00, 0x60,0x60,0x00,0x00,0x00,
    0x60,0x18,0x06,0x01,0x00,
    # 0-9 (ASCII 48-57)
    0x3e,0x41,0x41,0x3e,0x00, 0x42,0x7f,0x40,0x00,0x00,
    0x62,0x51,0x49,0x46,0x00, 0x21,0x49,0x4d,0x33,0x00, 0x18,0x16,0x11,0x7f,0x00,
    0x4f,0x49,0x49,0x31,0x00, 0x3c,0x4a,0x49,0x30,0x00, 0x01,0x61,0x19,0x07,0x00,
    0x36,0x49,0x49,0x36,0x00, 0x06,0x49,0x29,0x1e,0x00,
    # : through @ (ASCII 58-64)
    0x33,0x00,0x00,0x00,0x00,
    0x80,0x6c,0x00,0x00,0x00, 0x10,0x28,0x44,0x00,0x00, 0x28,0x28,0x28,0x00,0x00,
    0x44,0x28,0x10,0x00,0x00, 0x02,0x51,0x09,0x06,0x00, 0x3e,0x49,0x55,0x5e,0x00,
    # A-Z (ASCII 65-90)
    0x7e,0x09,0x09,0x7e,0x00, 0x7f,0x49,0x49,0x36,0x00, 0x3e,0x41,0x41,0x22,0x00,
    0x7f,0x41,0x41,0x3e,0x00, 0x7f,0x49,0x49,0x41,0x00, 0x7f,0x09,0x09,0x01,0x00,
    0x3e,0x41,0x49,0x79,0x00, 0x7f,0x08,0x08,0x7f,0x00, 0x41,0x7f,0x41,0x00,0x00,
    0x30,0x40,0x40,0x3f,0x00, 0x7f,0x08,0x14,0x63,0x00, 0x7f,0x40,0x40,0x40,0x00,
    0x7f,0x02,0x04,0x02,0x7f, 0x7f,0x02,0x04,0x7f,0x00, 0x3e,0x41,0x41,0x3e,0x00,
    0x7f,0x09,0x09,0x06,0x00, 0x3e,0x41,0x21,0x5e,0x00, 0x7f,0x09,0x19,0x66,0x00,
    0x46,0x49,0x49,0x31,0x00, 0x01,0x01,0x7f,0x01,0x01, 0x3f,0x40,0x40,0x3f,0x00,
    0x7f,0x40,0x20,0x1f,0x00, 0x3f,0x40,0x20,0x40,0x3f, 0x77,0x08,0x08,0x77,0x00,
    0x47,0x48,0x48,0x3f,0x00, 0x71,0x49,0x45,0x43,0x00,
    # [ through ` (ASCII 91-96)
    0x7f,0x41,0x00,0x00,0x00,
    0x01,0x06,0x18,0x60,0x00, 0x41,0x7f,0x00,0x00,0x00, 0x04,0x02,0x04,0x00,0x00,
    0x40,0x40,0x40,0x00,0x00, 0x01,0x01,0x00,0x00,0x00,
    # a-z (ASCII 97-122)
    0x20,0x54,0x54,0x78,0x00,
    0x7f,0x44,0x44,0x38,0x00, 0x38,0x44,0x44,0x28,0x00, 0x38,0x44,0x44,0x7f,0x00,
    0x38,0x54,0x54,0x58,0x00, 0x7e,0x09,0x09,0x02,0x00, 0x18,0xa4,0xa4,0x7c,0x00,
    0x7f,0x04,0x04,0x78,0x00, 0x04,0x7d,0x40,0x00,0x00, 0x60,0x80,0x80,0x7d,0x00,
    0x7f,0x10,0x28,0x44,0x00, 0x01,0x7f,0x40,0x00,0x00, 0x7c,0x04,0x78,0x04,0x78,
    0x7c,0x04,0x04,0x78,0x00, 0x38,0x44,0x44,0x38,0x00, 0xfc,0x24,0x24,0x18,0x00,
    0x18,0x24,0x24,0xfc,0x00, 0x7c,0x08,0x04,0x04,0x00, 0x48,0x54,0x54,0x24,0x00,
    0x3e,0x44,0x44,0x20,0x00, 0x3c,0x40,0x40,0x7c,0x00, 0x7c,0x40,0x20,0x1c,0x00,
    0x3c,0x40,0x20,0x40,0x3c, 0x6c,0x10,0x10,0x6c,0x00, 0x1c,0xa0,0xa0,0x7c,0x00,
    0x64,0x54,0x4c,0x00,0x00,
    # { through ~ (ASCII 123-126)
    0x08,0x3e,0x41,0x00,0x00, 0x7f,0x00,0x00,0x00,0x00,
    0x41,0x3e,0x08,0x00,0x00, 0x08,0x04,0x08,0x04,0x00, 0x00,0x00,0x00,0x00,0x00,
]

# bitmap6 font (6 pixels tall)
BITMAP6_WIDTHS = [
    3, 1, 3, 5, 5, 5, 6, 1, 2, 2, 3, 3, 1, 3, 1, 3,
    5, 2, 4, 4, 5, 4, 5, 5, 5, 5, 1, 1, 3, 3, 3, 4,
    6, 5, 5, 4, 5, 4, 4, 5, 4, 3, 4, 4, 4, 5, 5, 5,
    5, 5, 5, 4, 5, 5, 5, 5, 4, 4, 4, 2, 3, 2, 3, 3,
    2, 5, 5, 4, 5, 4, 4, 5, 4, 3, 4, 4, 4, 5, 5, 5,
    5, 5, 5, 4, 5, 5, 5, 5, 4, 4, 4, 3, 1, 3, 3, 1,
]

BITMAP6_DATA = [
    # Space through / (ASCII 32-47)
    0x00,0x00,0x00,0x00,0x00,0x00, 0x2e,0x00,0x00,0x00,0x00,0x00, 0x06,0x00,0x06,0x00,0x00,0x00,
    0x14,0x3e,0x14,0x3e,0x14,0x00, 0x04,0x2a,0x3e,0x2a,0x10,0x00, 0x22,0x10,0x08,0x04,0x22,0x00,
    0x14,0x2a,0x2a,0x2c,0x10,0x28, 0x06,0x00,0x00,0x00,0x00,0x00, 0x1c,0x22,0x00,0x00,0x00,0x00,
    0x22,0x1c,0x00,0x00,0x00,0x00, 0x14,0x08,0x14,0x00,0x00,0x00, 0x08,0x1c,0x08,0x00,0x00,0x00,
    0x60,0x00,0x00,0x00,0x00,0x00, 0x08,0x08,0x08,0x00,0x00,0x00, 0x20,0x00,0x00,0x00,0x00,0x00,
    0x30,0x0c,0x02,0x00,0x00,0x00,
    # 0-9 (ASCII 48-57)
    0x1c,0x22,0x22,0x22,0x1e,0x00, 0x02,0x3e,0x00,0x00,0x00,0x00,
    0x32,0x2a,0x2a,0x24,0x00,0x00, 0x2a,0x2a,0x2a,0x16,0x00,0x00, 0x0e,0x10,0x10,0x3e,0x10,0x00,
    0x2e,0x2a,0x2a,0x12,0x00,0x00, 0x3c,0x2a,0x2a,0x2a,0x12,0x00, 0x06,0x02,0x22,0x12,0x0e,0x00,
    0x14,0x2a,0x2a,0x2a,0x16,0x00, 0x04,0x2a,0x2a,0x2a,0x1e,0x00,
    # : through @ (ASCII 58-64)
    0x24,0x00,0x00,0x00,0x00,0x00,
    0x64,0x00,0x00,0x00,0x00,0x00, 0x08,0x14,0x22,0x00,0x00,0x00, 0x14,0x14,0x14,0x00,0x00,0x00,
    0x22,0x14,0x08,0x00,0x00,0x00, 0x02,0x2a,0x0a,0x04,0x00,0x00, 0x3c,0x02,0x1a,0x2a,0x22,0x1e,
    # A-Z (ASCII 65-90)
    0x3c,0x12,0x12,0x12,0x3e,0x00, 0x3c,0x2a,0x2a,0x2e,0x10,0x00, 0x1c,0x22,0x22,0x22,0x00,0x00,
    0x3c,0x22,0x22,0x22,0x1c,0x00, 0x3c,0x2a,0x2a,0x2a,0x00,0x00, 0x3c,0x12,0x12,0x12,0x00,0x00,
    0x3c,0x22,0x22,0x2a,0x1a,0x00, 0x3e,0x08,0x08,0x3e,0x00,0x00, 0x22,0x3e,0x22,0x00,0x00,0x00,
    0x30,0x22,0x22,0x1e,0x00,0x00, 0x3e,0x08,0x0c,0x32,0x00,0x00, 0x3e,0x20,0x20,0x20,0x00,0x00,
    0x3c,0x02,0x3c,0x02,0x3c,0x00, 0x3c,0x02,0x02,0x02,0x3e,0x00, 0x1c,0x22,0x22,0x22,0x1e,0x00,
    0x3c,0x12,0x12,0x12,0x0e,0x00, 0x1c,0x22,0x22,0x62,0x1e,0x00, 0x3c,0x12,0x12,0x32,0x0e,0x00,
    0x24,0x2a,0x2a,0x12,0x00,0x00, 0x02,0x02,0x3e,0x02,0x02,0x00, 0x1e,0x20,0x20,0x20,0x1e,0x00,
    0x0e,0x10,0x20,0x10,0x0e,0x00, 0x3e,0x20,0x1e,0x20,0x1e,0x00, 0x36,0x08,0x08,0x36,0x00,0x00,
    0x26,0x28,0x28,0x1e,0x00,0x00, 0x32,0x2a,0x2a,0x26,0x00,0x00,
    # [ through ` (ASCII 91-96)
    0x3e,0x22,0x00,0x00,0x00,0x00,
    0x02,0x0c,0x30,0x00,0x00,0x00, 0x22,0x3e,0x00,0x00,0x00,0x00, 0x04,0x02,0x04,0x00,0x00,0x00,
    0x20,0x20,0x20,0x00,0x00,0x00, 0x02,0x04,0x00,0x00,0x00,0x00,
    # a-z (ASCII 97-122) - same as uppercase for bitmap6
    0x3c,0x12,0x12,0x12,0x3e,0x00,
    0x3c,0x2a,0x2a,0x2e,0x10,0x00, 0x1c,0x22,0x22,0x22,0x00,0x00, 0x3c,0x22,0x22,0x22,0x1c,0x00,
    0x3c,0x2a,0x2a,0x2a,0x00,0x00, 0x3c,0x12,0x12,0x12,0x00,0x00, 0x3c,0x22,0x22,0x2a,0x1a,0x00,
    0x3e,0x08,0x08,0x3e,0x00,0x00, 0x22,0x3e,0x22,0x00,0x00,0x00, 0x30,0x22,0x22,0x1e,0x00,0x00,
    0x3e,0x08,0x0c,0x32,0x00,0x00, 0x3e,0x20,0x20,0x20,0x00,0x00, 0x3c,0x02,0x3c,0x02,0x3e,0x00,
    0x3c,0x02,0x02,0x02,0x3e,0x00, 0x1c,0x22,0x22,0x22,0x1e,0x00, 0x3c,0x12,0x12,0x12,0x0e,0x00,
    0x1c,0x22,0x22,0x62,0x1e,0x00, 0x3c,0x12,0x12,0x32,0x0e,0x00, 0x24,0x2a,0x2a,0x12,0x00,0x00,
    0x02,0x02,0x3e,0x02,0x02,0x00, 0x1e,0x20,0x20,0x20,0x1e,0x00, 0x0e,0x10,0x20,0x10,0x0e,0x00,
    0x3e,0x20,0x1e,0x20,0x1e,0x00, 0x36,0x08,0x08,0x36,0x00,0x00, 0x26,0x28,0x28,0x1e,0x00,0x00,
    0x32,0x2a,0x2a,0x26,0x00,0x00,
    # { through ~ (ASCII 123-126)
    0x08,0x3e,0x22,0x00,0x00,0x00, 0x3e,0x00,0x00,0x00,0x00,0x00,
    0x22,0x3e,0x08,0x00,0x00,0x00, 0x04,0x02,0x02,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,0x00,0x00,
]




# Unicode → ASCII transliteration for characters outside bitmap font range.
# The upstream Pimoroni firmware fonts only cover ASCII 32-126, so on real
# hardware these characters would not render either.  We transliterate to
# the closest ASCII equivalent so text stays readable in the emulator.
_UNICODE_TO_ASCII = {
    # Latin-1 Supplement accented vowels
    0xC0: 'A', 0xC1: 'A', 0xC2: 'A', 0xC3: 'A', 0xC4: 'A', 0xC5: 'A',  # À-Å
    0xC6: 'A',  # Æ
    0xC7: 'C',  # Ç
    0xC8: 'E', 0xC9: 'E', 0xCA: 'E', 0xCB: 'E',  # È-Ë
    0xCC: 'I', 0xCD: 'I', 0xCE: 'I', 0xCF: 'I',  # Ì-Ï
    0xD0: 'D',  # Ð
    0xD1: 'N',  # Ñ
    0xD2: 'O', 0xD3: 'O', 0xD4: 'O', 0xD5: 'O', 0xD6: 'O', 0xD8: 'O',  # Ò-Ö, Ø
    0xD9: 'U', 0xDA: 'U', 0xDB: 'U', 0xDC: 'U',  # Ù-Ü
    0xDD: 'Y',  # Ý
    0xDF: 's',  # ß → ss would change width, just use s
    0xE0: 'a', 0xE1: 'a', 0xE2: 'a', 0xE3: 'a', 0xE4: 'a', 0xE5: 'a',  # à-å
    0xE6: 'a',  # æ
    0xE7: 'c',  # ç
    0xE8: 'e', 0xE9: 'e', 0xEA: 'e', 0xEB: 'e',  # è-ë
    0xEC: 'i', 0xED: 'i', 0xEE: 'i', 0xEF: 'i',  # ì-ï
    0xF0: 'o',  # ð
    0xF1: 'n',  # ñ
    0xF2: 'o', 0xF3: 'o', 0xF4: 'o', 0xF5: 'o', 0xF6: 'o', 0xF8: 'o',  # ò-ö, ø
    0xF9: 'u', 0xFA: 'u', 0xFB: 'u', 0xFC: 'u',  # ù-ü
    0xFD: 'y', 0xFF: 'y',  # ý, ÿ
    # Common punctuation / symbols
    0x2018: "'", 0x2019: "'",  # ' '
    0x201C: '"', 0x201D: '"',  # " "
    0x2013: '-', 0x2014: '-',  # – —
    0x2026: '.',  # …
    0x0152: 'O', 0x0153: 'o',  # Œ, œ
}


class BitmapFont:
    """Pimoroni-compatible bitmap font."""

    def __init__(self, name: str, height: int, max_width: int,
                 widths: List[int], data: List[int]):
        self.name = name
        self.height = height
        self.max_width = max_width
        self.widths = widths
        self.data = data
        self.first_char = 32  # ASCII space

    def get_char_data(self, char: str) -> Tuple[List[int], int]:
        """Get bitmap data and width for a character.

        Returns:
            Tuple of (column_bytes, width)
        """
        code = ord(char)
        if code < self.first_char or code >= self.first_char + len(self.widths):
            # Try transliterating accented/extended characters to ASCII
            ascii_char = _UNICODE_TO_ASCII.get(code)
            if ascii_char:
                return self.get_char_data(ascii_char)
            # Return space for unknown characters
            return ([0] * self.max_width, self.widths[0])

        idx = code - self.first_char
        width = self.widths[idx]
        offset = idx * self.max_width

        # Get the bitmap columns for this character
        columns = self.data[offset:offset + self.max_width]
        return (columns, width)

    def measure_text(self, text: str, spacing: int = 1) -> int:
        """Measure the width of text in pixels."""
        if not text:
            return 0

        total = 0
        for char in text:
            _, width = self.get_char_data(char)
            total += width + spacing

        return total - spacing if total > 0 else 0


# Built-in fonts
_FONTS: Dict[str, BitmapFont] = {}


def _init_builtin_fonts():
    """Initialize built-in fonts."""
    global _FONTS

    if _FONTS:
        return

    _FONTS["bitmap8"] = BitmapFont(
        name="bitmap8",
        height=8,
        max_width=5,
        widths=BITMAP8_WIDTHS,
        data=BITMAP8_DATA,
    )

    _FONTS["bitmap6"] = BitmapFont(
        name="bitmap6",
        height=6,
        max_width=6,
        widths=BITMAP6_WIDTHS,
        data=BITMAP6_DATA,
    )


def get_font(name: str) -> Optional[BitmapFont]:
    """Get a font by name.

    Supported built-in fonts:
    - bitmap8: 8-pixel tall font (default)
    - bitmap6: 6-pixel tall compact font

    Args:
        name: Font name

    Returns:
        BitmapFont instance or None if not found
    """
    _init_builtin_fonts()

    if name in _FONTS:
        return _FONTS[name]

    # Try to download from Pimoroni repo if not found
    font = _try_download_font(name)
    if font:
        _FONTS[name] = font
        return font

    # Fall back to bitmap8
    return _FONTS.get("bitmap8")


# Fonts that are compiled into firmware and can't be downloaded
# These will fallback to bitmap8 silently
_FIRMWARE_ONLY_FONTS = {
    "serif", "sans", "gothic", "cursive", "sans_serif",
    "bitmap14_outline", "bitmap16",
}

# Track fonts we've already warned about
_warned_fonts = set()


def _try_download_font(name: str) -> Optional[BitmapFont]:
    """Try to download a font from Pimoroni's GitHub repo."""
    # Check if it's a firmware-only font (no download available)
    if name in _FIRMWARE_ONLY_FONTS:
        if name not in _warned_fonts:
            _warned_fonts.add(name)
            # Silently fall back - these fonts are in firmware only
        return None

    # Check cache first
    cache_file = CACHE_DIR / f"{name}.font"
    if cache_file.exists():
        try:
            return _load_cached_font(cache_file, name)
        except Exception:
            pass

    # Download from GitHub
    url = f"https://raw.githubusercontent.com/pimoroni/pimoroni-pico/main/libraries/bitmap_fonts/{name}_data.hpp"

    try:
        import urllib.request
        print(f"[fonts] Downloading {name} from {url}...")

        with urllib.request.urlopen(url, timeout=10) as response:
            content = response.read().decode('utf-8')

        font = _parse_font_hpp(content, name)
        if font:
            # Cache it
            CACHE_DIR.mkdir(parents=True, exist_ok=True)
            _save_cached_font(cache_file, font)
            print(f"[fonts] Cached {name} to {cache_file}")
            return font

    except Exception as e:
        print(f"[fonts] Failed to download {name}: {e}")

    return None


def _parse_font_hpp(content: str, name: str) -> Optional[BitmapFont]:
    """Parse a Pimoroni font .hpp file."""
    try:
        # Extract height
        height_match = re.search(r'height\s*=\s*(\d+)', content)
        height = int(height_match.group(1)) if height_match else 8

        # Extract max_width
        width_match = re.search(r'max_width\s*=\s*(\d+)', content)
        max_width = int(width_match.group(1)) if width_match else 5

        # Extract widths array
        widths_match = re.search(r'widths\[\]\s*=\s*\{([^}]+)\}', content)
        if widths_match:
            widths_str = widths_match.group(1)
            widths = [int(x.strip()) for x in widths_str.split(',') if x.strip().isdigit()]
        else:
            return None

        # Extract data array
        data_match = re.search(r'data\[\]\s*=\s*\{([^}]+)\}', content, re.DOTALL)
        if data_match:
            data_str = data_match.group(1)
            # Parse hex values
            data = []
            for match in re.finditer(r'0x([0-9a-fA-F]+)', data_str):
                data.append(int(match.group(1), 16))
        else:
            return None

        return BitmapFont(name, height, max_width, widths, data)

    except Exception as e:
        print(f"[fonts] Failed to parse {name}: {e}")
        return None


def _save_cached_font(path: Path, font: BitmapFont):
    """Save a font to cache."""
    import json
    data = {
        'name': font.name,
        'height': font.height,
        'max_width': font.max_width,
        'widths': font.widths,
        'data': font.data,
    }
    with open(path, 'w') as f:
        json.dump(data, f)


def _load_cached_font(path: Path, name: str) -> BitmapFont:
    """Load a font from cache."""
    import json
    with open(path, 'r') as f:
        data = json.load(f)
    return BitmapFont(
        name=data['name'],
        height=data['height'],
        max_width=data['max_width'],
        widths=data['widths'],
        data=data['data'],
    )


def list_fonts() -> List[str]:
    """List available fonts."""
    _init_builtin_fonts()
    return list(_FONTS.keys())
